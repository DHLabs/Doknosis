// Generated by CoffeeScript 1.9.1
(function() {
  window.Diagnosis || (window.Diagnosis = {});

  Diagnosis.clear_all = function() {
    window.symptoms = [];
    $('.rm').fadeOut('fast', function() {
      $(this.parentNode).remove();
      return this;
    });
    if ($('#symptoms-list > .help-text').length === 0) {
      $('#symptoms-list').append('<div class=\'help-text\'>No Symptoms Entered</div>');
    }
    $('#results').fadeOut();
    return this;
  };

  Diagnosis.get_diagnosis = function() {
    var params;
    if ($('#loading-indicator').is(":visible")) {
      window.diagnosis_refresh = true;
      return;
    }
    if (window.symptoms.length === 0) {
      $('#results').fadeOut();
      return;
    }
    $('#results').fadeOut();
    $('#results-list').html('');
    $('#loading-indicator').fadeIn();
    if ($('#banner-bar').data('at_top') !== true) {
      $('#banner-bar').data('at_top', true).animate({
        top: '0%',
        marginTop: '+=109'
      }, 500, null);
    }
    params = {
      findings: window.symptoms.join(','),
      num_solutions: $('#num_solutions').val(),
      num_combinations: $('#num_combinations').val(),
      type_identifier: $('#type_identifier').val(),
      algorithm: $('#algorithm').val()
    };
    $.getJSON('/diagnosis_result', params, function(data) {
      var dat, i, len, ref, results_table;
      if (data.success === !true) {
        alert('Failure -- ' + data.error);
        $('#loading-indicator').hide();
        return;
      }
      $('#query-time').html("DB QUERY TIME: " + data.query_time);
      $('<div/>').addClass('diagnosis').html("<strong>Most Likely:</strong> " + data.greedy).appendTo('#results-list');
      results_table = $('<table/>').addClass('results-table').addClass('table').addClass('table-striped').append('<tr><th>Name</th><th>Score</th></tr>');
      ref = data.other;
      for (i = 0, len = ref.length; i < len; i++) {
        dat = ref[i];
        $('<tr/>').append("<td> " + dat[0] + " </td>").append("<td> " + dat[1] + " </td>").appendTo(results_table);
      }
      $('#loading-indicator').hide();
      results_table.appendTo('#results-list');
      $('#results').fadeIn();
      if (window.diagnosis_refresh) {
        window.diagnosis_refresh = false;
        return Diagnosis.get_diagnosis();
      }
    });
    return this;
  };

  $(function() {
    window.symptoms = [];
    window.diagnosis_refresh = false;
    window.num_solutions.onchange = function() {
      return Diagnosis.get_diagnosis();
    };
    window.num_combinations.onchange = function() {
      return Diagnosis.get_diagnosis();
    };
    window.algorithm.onchange = function() {
      return Diagnosis.get_diagnosis();
    };
    window.type_identifier.onchange = function() {
      return Diagnosis.get_diagnosis();
    };
    $(document).on('click', '.rm', function() {
      var id;
      id = $(this).data('sid');
      if (window.symptoms.indexOf(id) !== -1) {
        window.symptoms.splice(window.symptoms.indexOf(id), 1);
        Diagnosis.get_diagnosis();
        return $(this.parentNode).fadeOut('fast', function() {
          $(this).remove();
          if ($('#symptoms-list > .label').length === 0) {
            return $('#symptoms-list').append('<div class=\'help-text\'>No Symptoms Entered</div>');
          }
        });
      }
    });
    $("#symptoms").autocomplete({
      source: '/api/finding/autocomplete',
      select: function(event, ui) {
        ui.item.value = '';
        $('#symptoms-list > .help-text').remove();
        $('#symptoms-list').append('<span class="label"><span>' + ui.item.label + '</span><span data-sid="' + ui.item.id + '" class="rm">x</span></span>');
        window.symptoms.push(ui.item.id);
        return Diagnosis.get_diagnosis();
      }
    });
    return this;
  });

}).call(this);
